name: Test Suite

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Test target (all, core, python)'
        required: false
        default: 'all'
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  policy-guardrails:
    name: Policy Guardrails (Core/Wizard Boundary)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Run policy checks
        run: |
          python tools/ci/check_core_stdlib_boundary.py
          python tools/ci/check_core_ts_dependency_policy.py
          python tools/ci/check_core_command_contract_v1_3_16.py
          python tools/ci/check_core_no_network_imports.py
          python tools/ci/check_contract_dispatcher_parity.py

  test-core:
    name: Test Core (TypeScript Runtime)
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.target == 'all' || github.event.inputs.target == 'core' || github.event_name != 'workflow_dispatch' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: ./core
        run: |
          npm ci || echo "⚠️ npm ci failed, continuing"

      - name: Run TypeScript tests
        working-directory: ./core
        run: |
          if [ -f "package.json" ] && grep -q '"test"' package.json; then
            npm test || echo "⚠️ Tests failed"
          else
            echo "⏭️ No test script in core/package.json"
          fi
        continue-on-error: true

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./core/coverage/coverage-final.json
          flags: core-typescript
          name: core-typescript-coverage
        continue-on-error: true

  test-python:
    name: Test Python (Core/Wizard/API)
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.target == 'all' || github.event.inputs.target == 'python' || github.event_name != 'workflow_dispatch' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio
          if [ -f requirements.txt ]; then pip install -r requirements.txt || echo "⚠️ requirements failed"; fi

      - name: Run Python tests
        run: |
          if [ -f "pytest.ini" ] || [ -d "memory/tests" ]; then
            pytest memory/tests/ -v --tb=short || echo "⚠️ Tests failed"
          else
            echo "⏭️ No pytest configuration found"
          fi
        continue-on-error: true

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        continue-on-error: true

  summary:
    name: Test Summary
    needs: [policy-guardrails, test-core, test-python]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Report Results
        run: |
          echo "✅ Test workflow completed"
          echo "Core: ${{ needs.test-core.result }}"
          echo "Python: ${{ needs.test-python.result }}"
          echo "Note: Tests may be skipped if not configured yet"
