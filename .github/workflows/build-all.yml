name: Build All

on:
  workflow_dispatch:
    inputs:
      build_id:
        description: 'Build identifier'
        required: false

jobs:
  build-core:
    name: Build Core
    uses: ./.github/workflows/build-core.yml
    with:
      target: core
      build_id: ${{ github.event.inputs.build_id || github.run_id }}
  
  build-wizard:
    name: Build Wizard
    uses: ./.github/workflows/build-wizard.yml
    with:
      target: wizard
      build_id: ${{ github.event.inputs.build_id || github.run_id }}
  
  build-api:
    name: Build API
    uses: ./.github/workflows/build-api.yml
    with:
      target: api
      build_id: ${{ github.event.inputs.build_id || github.run_id }}
  
  build-transport:
    name: Build Transport
    uses: ./.github/workflows/build-transport.yml
    with:
      target: transport
      build_id: ${{ github.event.inputs.build_id || github.run_id }}
  
  build-app:
    name: Build App
    uses: ./.github/workflows/build-app.yml
    with:
      target: app
      build_id: ${{ github.event.inputs.build_id || github.run_id }}
  
  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-core, build-wizard, build-api, build-transport, build-app]
    if: always()
    
    steps:
      - name: Check build results
        run: |
          echo "### Build Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Core | ${{ needs.build-core.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Wizard | ${{ needs.build-wizard.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API | ${{ needs.build-api.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Transport | ${{ needs.build-transport.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| App | ${{ needs.build-app.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.build-core.result }}" == "failure" ]] || \
             [[ "${{ needs.build-wizard.result }}" == "failure" ]] || \
             [[ "${{ needs.build-api.result }}" == "failure" ]] || \
             [[ "${{ needs.build-transport.result }}" == "failure" ]] || \
             [[ "${{ needs.build-app.result }}" == "failure" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ Some builds failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ All builds successful" >> $GITHUB_STEP_SUMMARY
          fi
