#!/bin/bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

load_env_safe() {
  local env_file="$1"
  [ -f "$env_file" ] || return 0
  while IFS= read -r line || [ -n "$line" ]; do
    line="${line#"${line%%[![:space:]]*}"}"
    line="${line%"${line##*[![:space:]]}"}"
    [ -z "$line" ] && continue
    case "$line" in
      \#*) continue ;;
    esac
    if [[ "$line" == export\ * ]]; then
      line="${line#export }"
    fi
    if [[ "$line" =~ ^[A-Za-z_][A-Za-z0-9_]*= ]]; then
      local key="${line%%=*}"
      local value="${line#*=}"
      if [[ "$value" =~ ^\".*\"$ ]]; then
        value="${value:1:${#value}-2}"
      elif [[ "$value" =~ ^\'.*\'$ ]]; then
        value="${value:1:${#value}-2}"
      fi
      export "$key=$value"
    fi
  done < "$env_file"
}

load_env_safe "$REPO_ROOT/.env"
source "$SCRIPT_DIR/udos-common.sh"
parse_common_flags "$@"

print_help() {
  cat <<'USAGE'
uCLI - unified terminal interface for uDOS

Usage:
  ./bin/ucli                Start uCLI TUI
  ./bin/ucli tui            Start uCLI TUI
  ./bin/ucli ts [command]   Run TS runtime lane (Node-gated, with core fallback guidance)
  ./bin/ucli wizard         Start Wizard server (GUI/API)
  ./bin/ucli wizard install Create/update Wizard venv at venv/ (or WIZARD_VENV_PATH)
  ./bin/ucli wizard doctor  Validate Wizard venv and core package imports
  ./bin/ucli clean-runtime  Remove build/dist/__pycache__/.pytest_cache safely
  ./bin/ucli prompt         Start shell-integrated prompt loop
  ./bin/ucli cmd <command>  Run one uCODE command via Wizard API
  ./bin/ucli help           Show this help

Notes:
  - uCLI is the only TUI.
  - Wizard GUI is the operational surface for web workflows.
  - uCODE is the command surface used by `cmd` and prompt flows.
USAGE
}

_wizard_health_ok() {
  local base_url="${WIZARD_BASE_URL:-http://127.0.0.1:8765}"
  curl -s --connect-timeout 2 "${base_url}/health" >/dev/null 2>&1
}

_python_bin() {
  if command -v python >/dev/null 2>&1; then
    echo "python"
  else
    echo "python3"
  fi
}

_is_housekeeping_cmd() {
  local first
  first="$(printf '%s' "$1" | awk '{print toupper($1)}')"
  case "$first" in
    DESTROY|REBOOT|SETUP|BACKUP|RESTORE|REPAIR)
      return 0
      ;;
    *)
      return 1
      ;;
  esac
}

_dispatch_ucode_local() {
  local command_text="$1"
  PYTHONPATH="$REPO_ROOT:${PYTHONPATH:-}" "$(_python_bin)" - <<'PY' "$command_text"
import sys
from core.tui.dispatcher import CommandDispatcher

cmd = sys.argv[1]
res = CommandDispatcher().dispatch(cmd)
text = (
    res.get("output")
    or res.get("rendered")
    or res.get("message")
    or str(res)
)
print(text)
status = str(res.get("status", "")).lower()
if status in {"error", "failed"}:
    raise SystemExit(1)
PY
}

_start_wizard_if_needed() {
  if _wizard_health_ok; then
    return 0
  fi
  launch_component wizard server >/dev/null
}

_dispatch_ucode() {
  local command_text="$1"
  [ -n "$command_text" ] || {
    echo "ucli cmd requires a command string" >&2
    return 2
  }

  if _is_housekeeping_cmd "$command_text"; then
    _dispatch_ucode_local "$command_text"
    return $?
  fi

  _start_wizard_if_needed || {
    echo "Failed to start Wizard server." >&2
    return 1
  }

  local base_url="${WIZARD_BASE_URL:-http://127.0.0.1:8765}"
  local escaped="${command_text//\"/\\\"}"

  local auth=()
  if [ -n "${WIZARD_ADMIN_TOKEN:-}" ]; then
    auth=(-H "Authorization: Bearer ${WIZARD_ADMIN_TOKEN}")
  fi

  local response http body
  response="$(curl -sS -w $'\n%{http_code}' \
    -H "Content-Type: application/json" \
    "${auth[@]}" \
    -d "{\"command\": \"${escaped}\"}" \
    "${base_url}/api/ucode/dispatch")"

  http="${response##*$'\n'}"
  body="${response%$'\n'*}"

  if [[ ! "$http" =~ ^2 ]]; then
    if _is_housekeeping_cmd "$command_text" && printf '%s' "$body" | grep -qi "command not allowed"; then
      _dispatch_ucode_local "$command_text"
      return $?
    fi
    printf '%s\n' "$body"
    return 1
  fi

  "$(_python_bin)" - <<'PY' "$body"
import json
import sys
raw = sys.argv[1]
try:
    payload = json.loads(raw)
except Exception:
    print(raw)
    sys.exit(0)

rendered = payload.get("rendered")
if rendered:
    print(rendered)
    sys.exit(0)

result = payload.get("result")
if isinstance(result, dict):
    output = result.get("output")
    if output:
        print(output)
        sys.exit(0)
    message = result.get("message")
    if message:
        print(message)
        sys.exit(0)

message = payload.get("message")
if message:
    print(message)
else:
    print(raw)
PY
}

_node_runtime_available() {
  command -v node >/dev/null 2>&1 || return 1
  node --version >/dev/null 2>&1 || return 1
}

_ts_to_ucode_command() {
  local action="${1:-}"
  local action_lc
  if [ $# -eq 0 ]; then
    echo "VERIFY"
    return 0
  fi

  action_lc="$(printf "%s" "$action" | tr '[:upper:]' '[:lower:]')"
  shift || true
  case "$action_lc" in
    verify)
      echo "VERIFY $*"
      ;;
    pat|pattern)
      echo "DRAW PAT $*"
      ;;
    draw)
      if [ "${1:-}" = "pat" ] || [ "${1:-}" = "PAT" ]; then
        shift || true
      fi
      echo "DRAW PAT $*"
      ;;
    data)
      echo "RUN DATA $*"
      ;;
    run)
      if [ "${1:-}" = "data" ] || [ "${1:-}" = "DATA" ]; then
        shift || true
        echo "RUN DATA $*"
      else
        echo "RUN $*"
      fi
      ;;
    *)
      echo "$action $*"
      ;;
  esac
}

_run_ts_surface() {
  local mapped_cmd
  mapped_cmd="$(_ts_to_ucode_command "$@")"

  if ! _node_runtime_available; then
    echo "Node runtime not detected. Falling back to core mode." >&2
    if [ -n "$mapped_cmd" ]; then
      echo "Equivalent core command: $mapped_cmd" >&2
    fi
    if [ -t 0 ] && [ -w /dev/tty ] && [ $# -eq 0 ]; then
      launch_component core tui
      return $?
    fi
    if [ $# -eq 0 ]; then
      echo "Run from an interactive terminal to open core mode." >&2
    fi
    return 0
  fi

  _dispatch_ucode "$mapped_cmd"
}

subcommand="${1:-tui}"
shift || true

case "$subcommand" in
  core)
    echo "Unknown subcommand: core. Use: tui" >&2
    exit 2
    ;;
  server)
    echo "Unknown subcommand: server. Use: wizard" >&2
    exit 2
    ;;
  command|run)
    echo "Unknown subcommand: $subcommand. Use: cmd" >&2
    exit 2
    ;;
esac

case "$subcommand" in
  help|-h|--help)
    print_help
    ;;
  tui)
    launch_component core tui "$@"
    ;;
  wizard)
    wizard_subcommand="${1:-server}"
    shift || true
    case "$wizard_subcommand" in
      install)
        wizard_install_env
        ;;
      doctor)
        wizard_doctor_env
        ;;
      server)
        launch_component wizard server "$@"
        ;;
      *)
        echo "Unknown wizard subcommand: $wizard_subcommand" >&2
        echo "Use one of: server | install | doctor" >&2
        exit 2
        ;;
    esac
    ;;
  prompt)
    exec "$SCRIPT_DIR/vibe-wrapper.sh" "$@"
    ;;
  ts)
    _run_ts_surface "$@"
    ;;
  cmd)
    _dispatch_ucode "$*"
    ;;
  clean-runtime)
    clean_runtime_artifacts
    ;;
  *)
    # Treat free-form input as a single uCODE command for shell usage.
    _dispatch_ucode "$subcommand $*"
    ;;
esac
