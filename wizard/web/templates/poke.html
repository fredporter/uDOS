{% extends "base.html" %}

{% block content %}
<div x-data="pokePanel()">
    <!-- Page Header -->
    <div class="px-4 sm:px-0 mb-8">
        <h1 class="text-3xl font-bold text-white">POKE Server</h1>
        <p class="mt-1 text-gray-400">Host files and pages from your Wizard Server</p>
    </div>
    
    <!-- Upload Section -->
    <div class="bg-gray-800 rounded-lg p-6 mb-6 border border-gray-700">
        <h2 class="text-lg font-semibold text-white mb-4">Upload New Content</h2>
        
        <div 
            class="border-2 border-dashed border-gray-600 rounded-lg p-8 text-center hover:border-blue-500 transition-colors"
            @dragover.prevent="dragOver = true"
            @dragleave="dragOver = false"
            @drop.prevent="handleDrop($event)"
            :class="{ 'border-blue-500 bg-blue-900/20': dragOver }"
        >
            <input 
                type="file" 
                id="file-input" 
                class="hidden" 
                @change="handleFileSelect($event)"
                multiple
            >
            <label for="file-input" class="cursor-pointer">
                <span class="text-4xl mb-4 block">üìÅ</span>
                <p class="text-gray-300 mb-2">Drop files here or click to upload</p>
                <p class="text-gray-500 text-sm">HTML, Markdown, Images, JSON, or any static file</p>
            </label>
        </div>
        
        <!-- URL Generator -->
        <div class="mt-4 grid grid-cols-2 gap-4">
            <div>
                <label class="text-xs text-gray-400 uppercase block mb-1">Custom Path</label>
                <input 
                    type="text"
                    x-model="customPath"
                    placeholder="/my-page"
                    class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm"
                >
            </div>
            <div>
                <label class="text-xs text-gray-400 uppercase block mb-1">Access</label>
                <select 
                    x-model="accessLevel"
                    title="Access level"
                    class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm"
                >
                    <option value="public">Public (anyone with link)</option>
                    <option value="mesh">Mesh Only (paired devices)</option>
                    <option value="private">Private (Wizard admin only)</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- Hosted Items -->
    <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
        <div class="px-4 py-3 border-b border-gray-700 flex items-center justify-between">
            <h2 class="text-lg font-semibold text-white">Hosted Content</h2>
            <span class="text-gray-400 text-sm">{{ items|length }} items</span>
        </div>
        
        <table class="w-full">
            <thead class="bg-gray-900">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">File</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">URL</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Size</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Views</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Created</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-700">
                {% for item in items %}
                <tr class="hover:bg-gray-700/50">
                    <td class="px-4 py-3">
                        <div class="flex items-center">
                            <span class="text-xl mr-2">
                                {% if item.name.endswith('.html') %}üìÑ
                                {% elif item.name.endswith('.md') %}üìù
                                {% elif item.name.endswith('.json') %}üìã
                                {% elif item.name.endswith(('.png', '.jpg', '.gif')) %}üñºÔ∏è
                                {% else %}üìé{% endif %}
                            </span>
                            <span class="text-white">{{ item.name }}</span>
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <a href="/p/{{ item.name }}" target="_blank" class="text-blue-400 hover:text-blue-300">
                            /p/{{ item.name }}
                        </a>
                    </td>
                    <td class="px-4 py-3 text-gray-400">{{ item.size }}</td>
                    <td class="px-4 py-3 text-gray-400">{{ item.views }}</td>
                    <td class="px-4 py-3 text-gray-400">{{ item.created }}</td>
                    <td class="px-4 py-3 text-right">
                        <button 
                            @click="copyUrl('/p/{{ item.name }}')"
                            class="px-2 py-1 text-gray-400 hover:text-white"
                            title="Copy URL"
                        >
                            üìã
                        </button>
                        <button 
                            hx-delete="/api/poke/{{ item.name }}"
                            hx-confirm="Delete {{ item.name }}?"
                            hx-swap="outerHTML"
                            hx-target="closest tr"
                            class="px-2 py-1 text-gray-400 hover:text-red-400"
                            title="Delete"
                        >
                            üóëÔ∏è
                        </button>
                    </td>
                </tr>
                {% endfor %}
                
                {% if not items %}
                <tr>
                    <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                        No hosted content yet. Upload your first file above.
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<script>
function pokePanel() {
    return {
        dragOver: false,
        customPath: '',
        accessLevel: 'public',
        
        handleDrop(event) {
            this.dragOver = false;
            const files = event.dataTransfer.files;
            this.uploadFiles(files);
        },
        
        handleFileSelect(event) {
            const files = event.target.files;
            this.uploadFiles(files);
        },
        
        async uploadFiles(files) {
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('path', this.customPath || file.name);
                formData.append('access', this.accessLevel);
                
                try {
                    const response = await fetch('/api/poke/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        // Refresh the page to show new file
                        window.location.reload();
                    }
                } catch (error) {
                    console.error('Upload failed:', error);
                }
            }
        },
        
        copyUrl(url) {
            const fullUrl = window.location.origin + url;
            navigator.clipboard.writeText(fullUrl);
            // Could add a toast notification here
        }
    }
}
</script>
{% endblock %}
